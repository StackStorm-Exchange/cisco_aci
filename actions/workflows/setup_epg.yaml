---
version: '2.0'

cisco_aci.setup_epg:
  description: "Create an EPG with supporting bridge domain and Static Bindings"
  input:
    - apic
    - epg_spec
    - credentials
  tasks:
    build_ap:
      action: cisco_aci.create_ap
      input:
        apic: <% $.apic %>
        data: <% $.epg_spec %>
        credentials: <% $.credentials %>
      on-success:
        - wait_for_build_ap
    wait_for_build_ap:
      action: core.pause
      input:
        max_pause: 2
      on-success:
        - build_bd 
    build_bd:
      action: cisco_aci.create_bd
      input:
        apic: <% $.apic %>
        data: <% $.epg_spec %>
        credentials: <% $.credentials %>
      on-success:
        - wait_for_build_bd
    wait_for_build_bd:
      action: core.pause
      input:
        max_pause: 2
      on-success:
        - build_epg 
    build_epg:
      action: cisco_aci.create_epg
      input:
        apic: <% $.apic %>
        data: <% $.epg_spec %>
        credentials: <% $.credentials %>
      on-success:
        - wait_for_build_epg
    wait_for_build_epg:
      action: core.pause
      input:
        max_pause: 2
      on-success:
        - link_domains
    link_domains:
      action: cisco_aci.link_domain
      input:
        apic: <% $.apic %>
        data: <% $.epg_spec %>
        credentials: <% $.credentials %>
      on-success:
        - wait_for_link_domains
    wait_for_link_domains:
      action: core.pause
      input:
        max_pause: 2
      on-success:
        - build_static_bindings
    build_static_bindings:
      action: cisco_aci.create_static_binding
      input:
        apic: <% $.apic %>
        data: <% $.epg_spec %>
        credentials: <% $.credentials %>
      on-success:
        - wait_for_build_static_bindings
    wait_for_build_static_bindings:
      action: core.pause
      input:
        max_pause: 2
